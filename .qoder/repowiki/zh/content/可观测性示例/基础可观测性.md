# 基础可观测性

<cite>
**本文档中引用的文件**  
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observability-example/src/main/java/com/alibaba/cloud/ai/example/observability/controller/ChatModelController.java)
- [application.yml](file://spring-ai-alibaba-observability-example/observability-example/src/main/resources/application.yml)
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observationhandler-example/src/main/java/com/alibaba/cloud/ai/observationhandlerexample/controller/ChatModelController.java)
- [application.yml](file://spring-ai-alibaba-observability-example/observationhandler-example/src/main/resources/application.yml)
- [application.yml](file://spring-ai-alibaba-observability-example/observability-arms-example/src/main/resources/application.yml)
- [application.yml](file://spring-ai-alibaba-observability-example/observability-langfuse-example/src/main/resources/application.yml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细介绍了如何在Spring AI Alibaba应用中实现基础可观测性功能，涵盖日志记录、指标收集和链路追踪。重点分析了`ChatModelController`中的实现细节，包括如何通过注解或编程方式捕获AI模型调用的关键信息（如请求/响应时间、token使用量和错误率）。同时提供了`application.yml`中的配置示例，说明如何启用和配置基本的可观测性功能。文档为初学者提供了简单的代码示例，帮助快速集成基础监控，并为经验丰富的开发者深入讲解自定义监控数据的收集与输出格式。最终解释这些功能如何帮助开发者理解AI应用的运行状况和性能瓶颈。

## 项目结构
Spring AI Alibaba的可观测性示例项目位于`spring-ai-alibaba-observability-example`目录下，包含多个子模块，分别演示不同场景下的可观测性集成方式。主要模块包括：
- `observability-example`：基础可观测性功能演示
- `observability-arms-example`：集成ARMS（阿里云应用实时监控服务）
- `observationhandler-example`：自定义ObservationHandler
- `observability-langfuse-example`：集成Langfuse进行AI调用追踪

每个模块均包含标准的Spring Boot结构，核心配置文件为`application.yml`，控制器位于`controller`包下。

```mermaid
graph TD
A[spring-ai-alibaba-observability-example] --> B[observability-example]
A --> C[observability-arms-example]
A --> D[observationhandler-example]
A --> E[observability-langfuse-example]
B --> F[ChatModelController]
B --> G[application.yml]
D --> H[ChatModelController]
D --> I[application.yml]
```

**图示来源**  
- [observability-example](file://spring-ai-alibaba-observability-example/observability-example)
- [observationhandler-example](file://spring-ai-alibaba-observability-example/observationhandler-example)

## 核心组件

`ChatModelController`是实现AI模型调用可观测性的核心组件，通过`ChatClient`与底层AI模型交互，并自动触发观测事件。在基础示例中，控制器通过构造函数注入`ChatClient.Builder`，并在`chat`方法中发起流式响应调用。

在自定义观测处理器示例中，`ChatModelController`直接使用`DashScopeChatModel`并显式注册自定义的`CustomerObservationHandler`，实现对观测数据的完全控制。

**组件来源**  
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observability-example/src/main/java/com/alibaba/cloud/ai/example/observability/controller/ChatModelController.java#L15-L31)
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observationhandler-example/src/main/java/com/alibaba/cloud/ai/observationhandlerexample/controller/ChatModelController.java#L34-L55)

## 架构概述

Spring AI Alibaba的可观测性基于Micrometer Tracing和OpenTelemetry实现，通过声明式配置自动收集AI调用的完整链路信息。系统架构分为三层：
1. **应用层**：`ChatModelController`处理HTTP请求，调用AI模型
2. **观测层**：`ChatClient`和`ChatModel`自动触发观测事件
3. **导出层**：通过Zipkin、Langfuse或ARMS导出追踪数据

```mermaid
graph TB
subgraph "应用层"
A[ChatModelController]
end
subgraph "观测层"
B[ChatClient]
C[ObservationRegistry]
end
subgraph "导出层"
D[Zipkin]
E[Langfuse]
F[ARMS]
end
A --> B
B --> C
C --> D
C --> E
C --> F
```

**图示来源**  
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observability-example/src/main/java/com/alibaba/cloud/ai/example/observability/controller/ChatModelController.java)
- [application.yml](file://spring-ai-alibaba-observability-example/observability-example/src/main/resources/application.yml)

## 详细组件分析

### ChatModelController 分析

`ChatModelController`是AI调用的入口点，其设计体现了Spring AI的响应式编程模型和观测集成。

#### 基础实现
在`observability-example`中，`ChatModelController`采用依赖注入方式获取`ChatClient`，通过`prompt().stream().content()`实现流式响应。该调用会自动触发配置的观测行为。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "ChatModelController"
participant Client as "ChatClient"
participant Model as "AI模型"
Client->>Controller : GET /observability/chat?prompt=...
Controller->>Client : prompt(prompt)
Client->>Model : 发送请求
Model-->>Client : 流式响应
Client-->>Controller : Flux<String>
Controller-->>Client : 流式返回
```

**图示来源**  
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observability-example/src/main/java/com/alibaba/cloud/ai/example/observability/controller/ChatModelController.java#L15-L31)

#### 自定义观测处理器实现
在`observationhandler-example`中，`ChatModelController`通过编程方式注册自定义的`CustomerObservationHandler`，实现了对观测过程的完全控制。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "ChatModelController"
participant Registry as "ObservationRegistry"
participant Handler as "CustomerObservationHandler"
participant Model as "DashScopeChatModel"
Controller->>Registry : 注册自定义Handler
Client->>Controller : GET /custom/observation/chat
Controller->>Model : call(message)
Model->>Registry : 创建Observation
Registry->>Handler : onStart, onEvent, ...
Model-->>Controller : 响应结果
Controller-->>Client : 返回结果
```

**图示来源**  
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observationhandler-example/src/main/java/com/alibaba/cloud/ai/observationhandlerexample/controller/ChatModelController.java#L34-L55)

### 配置分析

可观测性功能主要通过`application.yml`进行声明式配置，支持细粒度控制。

#### 基础配置
```mermaid
flowchart TD
A["application.yml"] --> B["spring.ai.chat.client.observations"]
A --> C["spring.ai.dashscope.observations"]
A --> D["spring.ai.vectorstore.observations"]
A --> E["spring.ai.tools.observations"]
B --> F["log-prompt: true"]
B --> G["log-completion: true"]
B --> H["include-error-logging: true"]
C --> I["log-prompt: true"]
C --> J["log-completion: true"]
D --> K["log-query-response: true"]
E --> L["include-content: true"]
A --> M["management.tracing.sampling.probability: 1.0"]
A --> N["management.zipkin.tracing.endpoint"]
```

**图示来源**  
- [application.yml](file://spring-ai-alibaba-observability-example/observability-example/src/main/resources/application.yml#L1-L64)

#### ARMS 集成配置
```yaml
spring:
  application:
    name: observability-arms-dashscope
  ai:
    dashscope:
      observations:
        log-completion: true
        log-prompt: true
management:
  tracing:
    sampling:
      probability: 1.0
```

**配置来源**  
- [application.yml](file://spring-ai-alibaba-observability-example/observability-arms-example/src/main/resources/application.yml#L1-L59)

#### Langfuse 集成配置
```yaml
otel:
  exporter:
    otlp:
      endpoint: "https://cloud.langfuse.com/api/public/otel"
      headers:
        Authorization: "Basic YOUR_BASE64_ENCODED_CREDENTIALS"
```

**配置来源**  
- [application.yml](file://spring-ai-alibaba-observability-example/observability-langfuse-example/src/main/resources/application.yml)

## 依赖分析

可观测性功能依赖于Spring Boot的管理端点和Micrometer Tracing生态系统。

```mermaid
graph TD
A[ChatModelController] --> B[ChatClient]
B --> C[ObservationRegistry]
C --> D[Zipkin]
C --> E[OpenTelemetry]
C --> F[ARMS]
G[ObservationHandler] --> C
H[application.yml] --> C
H --> I[management.endpoints]
H --> J[management.tracing]
```

**图示来源**  
- [pom.xml](file://spring-ai-alibaba-observability-example/pom.xml#L37-L66)
- [application.yml](file://spring-ai-alibaba-observability-example/observability-example/src/main/resources/application.yml)

## 性能考虑

可观测性配置中的`management.tracing.sampling.probability`参数对性能有重要影响。设置为`1.0`表示记录所有请求的追踪信息，适合调试环境；生产环境建议降低采样率以减少性能开销。日志记录选项（如`log-prompt`和`log-completion`）也会增加I/O负载，应根据实际监控需求启用。

## 故障排除指南

常见问题及解决方案：
- **追踪数据未上报**：检查`management.zipkin.tracing.endpoint`配置是否正确，确保Zipkin服务可访问
- **观测日志缺失**：确认`spring.ai.*.observations`相关配置已启用
- **自定义处理器未生效**：确保`ObservationRegistry`已正确注册处理器
- **ARMS集成失败**：验证应用名称配置和网络连通性

**问题来源**  
- [application.yml](file://spring-ai-alibaba-observability-example/observability-example/src/main/resources/application.yml#L50-L64)
- [ChatModelController.java](file://spring-ai-alibaba-observability-example/observationhandler-example/src/main/java/com/alibaba/cloud/ai/observationhandlerexample/controller/ChatModelController.java#L34-L55)

## 结论

Spring AI Alibaba提供了完善的可观测性支持，通过简单的YAML配置即可实现AI模型调用的全面监控。开发者可以根据需求选择基础配置、自定义处理器或第三方集成（如Langfuse、ARMS）等不同方案。这些功能帮助开发者深入理解AI应用的运行状况，识别性能瓶颈，优化调用成本，是构建生产级AI应用的重要基础。